#!/usr/bin/env python3
#  _______   _______
# |  _____| |  ___  |
# | |       | |   | |    Rolando Ramos Torres (@rolodoom)
# | |       | |___| |    http://rolandoramostorres.com
# |_|       |_______|
#  _         _______
# | |       |  ___  |
# | |       | |   | |    r_pw_latency
# | |_____  | |___| |    Set the latency for pipewire on local
# |_______| |_______|    file $HOME/.config/pipewire/jack.conf
#
#
#

import os

DEFAULT_LATENCY = "256"
DEFAULT_RATE = "48000"
CONF_FILE_STRING = "$HOME/.config/pipewire/jack.conf"


def update_conf_file(conf_file_path, latency_rate):
    latency_values = ["16", "32", "64", "128", "256", "512", "1024", "2048", "4096"]
    rate_values = ["44100", "48000", "96000"]

    # Validar entrada o usar valores por defecto
    if not latency_rate:
        latency = DEFAULT_LATENCY
        rate = DEFAULT_RATE
        print(f"No input provided! {DEFAULT_LATENCY} {DEFAULT_RATE} are used.")
    else:
        values = latency_rate.split()
        latency = values[0].strip()
        if len(values) > 1:
            rate = values[1].strip()
        else:
            rate = DEFAULT_RATE
            print(f"No rate value provided! {DEFAULT_RATE} is used.")

        if latency not in latency_values or rate not in rate_values:
            latency = DEFAULT_LATENCY
            rate = DEFAULT_RATE
            print(f"Invalid input! {DEFAULT_LATENCY} {DEFAULT_RATE} are used.")

    try:
        with open(conf_file_path, "r") as f:
            lines = f.readlines()

        updated_lines = []
        updated_latency_line = False
        inside_jack_properties = False

        for line in lines:
            stripped = line.strip()

            # Detectar inicio del bloque jack.properties
            if stripped.startswith("jack.properties") and "{" in stripped:
                inside_jack_properties = True
            elif inside_jack_properties and "}" in stripped:
                inside_jack_properties = False

            # Solo modificar node.latency si estamos dentro del bloque
            if inside_jack_properties and "node.latency" in stripped:
                if "#" in line:
                    line = line.replace("#", "")
                line = f"     node.latency       = {latency}/{rate}\n"
                updated_latency_line = True

            updated_lines.append(line)

        # Solo escribir si se modific√≥ node.latency dentro del bloque
        if updated_latency_line:
            with open(conf_file_path, "w") as f:
                f.writelines(updated_lines)
            print(f"Configuration file updated successfully!")
        else:
            print(
                f"Warning: 'node.latency' not found inside 'jack.properties' in '{conf_file_path}'. No changes were made."
            )

    except FileNotFoundError:
        print(f"Error: Configuration file '{conf_file_path}' not found!")


if __name__ == "__main__":
    print("")
    latency_rate = input("Enter the values separated by space (e.g., 256 48000): ")

    conf_file_path = CONF_FILE_STRING.replace("$HOME", os.path.expanduser("~"))

    update_conf_file(conf_file_path, latency_rate)
    print("")
